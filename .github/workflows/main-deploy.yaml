name: Deploy main branch

on:
  push:
    branches: ['main']

permissions:
  contents: write
  id-token: write

jobs:

  release:
    runs-on: ubuntu-latest

    outputs:
      tag_name: ${{ steps.release.outputs.tag_name }}

    steps:
    - uses: actions/checkout@v3

    - name: Bump version and push tag
      id: release
      uses: rymndhng/release-on-push-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        bump_version_scheme: patch
        use_github_release_notes: true

  deploy:
    needs: release
    if: needs.release.outputs.tag != ''
    runs-on: ubuntu-latest

    environment:
      name: staging
      url: ${{ steps.deploy.outputs.url }}

    env:
      IMAGE: gcr.io/${{ vars.GOOGLE_PROJECT }}/${{ vars.SERVICE_ID }}
      TAG: ${{ needs.release.outputs.tag_name }}

    outputs:
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - uses: google-github-actions/auth@v1
        id: auth
        with:
          token_format: access-token
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - uses: docker/login-action@v2
        with:
          registry: gcr.io
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.access_token }}

      - uses: docker/build-push-action@v3
        with:
          push: true
          tags: |
            ${{ env.IMAGE }}:latest
            ${{ env.IMAGE }}:${{ env.TAG }}

      - uses: google-github-actions/deploy-cloudrun@v0
        id: deploy
        with:
          service: ${{ vars.SERVICE_ID }}
          region: ${{ vars.REGION }}
          image: ${{ env.IMAGE }}:${{ env.TAG }}

  test:
    needs: deploy
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - uses: Xotabu4/selenoid-github-action@v2

    - uses: actions/setup-python@v4
      with:
        python-version-file: '.python-version'
        cache: pip

    - run: make deps

    - run: make test-e2e
      env:
        SELENIUM_DRIVER: remote
        SELENIUM_REMOTE_URL: http://localhost:4444/wd/hub
        E2E_TEST_CONSENT_API_URL: ${{ needs.deploy.outputs.url }}
        E2E_TEST_GOVUK_URL: https://sde-prototype-govuk-j4f7bdslta-nw.a.run.app/
        E2E_TEST_HAAS_URL: https://haas-j4f7bdslta-nw.a.run.app/
